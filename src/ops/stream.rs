use rand::seq::IndexedRandom;
use teloxide::{
    Bot,
    payloads::SetMessageReactionSetters,
    prelude::Requester,
    sugar::request::RequestReplyExt,
    types::{Me, ReactionType, Update},
};

use crate::ops::{consts::STREAM_KEYWORD, error::Error};

fn random_quote() -> String {
    let pool = vec![
        "Ð¢Ñ‹ ÑÐ´Ð¾Ñ…Ð½ÐµÑˆÑŒ Ð² Ð°Ð´Ñƒ ÑƒÑ€Ð¾Ð´".to_string(),
        "Ð¯ Ð±Ñ‹ Ñ‚ÐµÐ±Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ð¾ Ñ‚Ð²Ð¾ÐµÐ¹ Ð»Ñ‹ÑÐ¸Ð½Ðµ Ð²Ð¾Ð½ÑŽÑ‡ÐµÐ¹ c Ð¿Ñ‹Ñ€Ñƒ Ð²ÑŠÐµÐ±Ð°Ð»".to_string(),
        "Ð”Ð° Ð´Ð° Ð½ÐµÑ‚ Ð½ÐµÑ‚, Ð¿Ð¾Ð´ÑƒÐ¼Ð°Ñ‚ÑŒ Ð´Ð¾ Ð·Ð°Ð²Ñ‚Ñ€Ð° ÐµÑÑ‚ÑŒ Ð²Ñ€ÐµÐ¼Ñ Ñƒ Ñ‚ÐµÐ±Ñ".to_string(),
        "ÐœÑ‹ Ð½Ð° ÑÐ²Ð¾ Ð¿Ð¾Ð¹Ð´ÐµÐ¼ Ñ€Ð¾Ð´Ð¸Ð½Ñƒ Ð·Ð°Ñ‰Ð¸Ñ‰Ð°Ñ‚ÑŒ ?".to_string(),
        "ÑÐ»Ð°Ð²Ð° Ð±Ð¾Ð³Ñƒ Ð¼Ñ‹ Ð¶Ð¸Ð²ÐµÐ¼ Ð² Ñ€Ð¾ÑÑÐ¸Ð¸, Ð° Ð½Ðµ Ð² Ð°Ð¼ÐµÑ€Ð¸ÐºÐµ".to_string(),
        "Ð”Ð°, Ñ€Ð°ÐºÑƒÑ€Ñ Ð´ÐµÐ»Ð°ÐµÑ‚ Ð²ÐµÑ‰Ð¸, Ð² Ð¶Ð¸Ð·Ð½Ð¸ Ñ‚Ñ‹ Ð±Ñ‹ ÑƒÐ²Ð¸Ð´ÐµÐ», Ð¿Ð¸ÑÐµ Ð½Ðµ Ð¿Ð¾Ð´Ð½ÑÐ»Ð°ÑÑŒ Ð±Ñ‹".to_string(),
        "Ð”ÐµÐ²ÑƒÑˆÐºÐ° Ð±Ð¾Ñ€Ð¸ÑÐ°".to_string(),
        "Ñ‚Ñ‹ 1Ñ…1 Ð½Ðµ Ñ…Ð¾Ñ‡ÐµÑˆÑŒ Ð¿Ð¾Ð¹Ñ‚Ð¸ Ð¿Ð¾Ð¿Ð¸Ð·Ð´Ð¸Ñ‚ÑŒÑÑ? Ñ‡Ð¸ÑÑ‚Ð¾ Ð·Ð° Ñ‡ÐµÑÑ‚ÑŒ Ð²Ð»Ð°Ð´Ð¸Ð¼Ð¸Ñ€Ð° Ð¿ÑƒÑ‚Ð¸Ð½Ð°".to_string(),
        "Ð¯ Ð·Ð° Ð»ÑŽÐ»Ñ ÐºÐµÐ±Ð°Ð± Ð½Ð° Ð¿ÑÑ‚ÑŒÑÐ¾Ñ‚ Ð ÑƒÐ±Ð»ÐµÐ²Ð¾Ð¹ ÐºÑƒÐ¿ÑŽÑ€Ðµ".to_string(),
        "Ð¯ Ð±Ñ‹ Ð²Ð¼ÐµÑˆÐ°Ð»ÑÑ, Ð½Ð¾ Ð¼Ð½Ðµ Ð²Ð¿Ð½ Ð´Ð¾Ñ€Ð¾Ð¶Ðµ".to_string(),
        "ÐÐ´ÐµÐºÐ²Ð°Ñ‚Ð½Ñ‹Ð¹ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ñ‚Ð°ÐºÐ¾Ðµ Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð½Ðµ Ð±ÑƒÐ´ÐµÑ‚".to_string(),
        "ÐÑƒ Ñ Ð¿Ð¾Ð½ÑÐ» Ð³ÑƒÐ»ÑÑˆ Ð³Ð¾Ð²Ð½Ð¾ Ð¿Ð¾Ñ‚Ð¾Ð¼Ñƒ Ñ‡Ñ‚Ð¾ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°ÐµÑ‚ ÑÑÑÑ€".to_string(),
        "Ð¯ Ð±Ñ€Ð°Ð» Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ Ð¿Ð¸ÐºÐ½Ð¸Ðº Ð¸ Ñ‚Ð°Ð¼ Ð±Ñ‹Ð»Ð¾ 2 Ñ€Ð°Ð·Ð½Ð¾Ð²Ð¸Ð´Ð½Ð¾ÑÑ‚Ð¸, Ð¾Ð´Ð¸Ð½ Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ð¹, Ð´Ñ€ÑƒÐ³Ð¾Ð¹ ÐºÐ°ÐºÐ¾Ð¹-Ñ‚Ð¾ Ð½ÐµÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ð¹, Ñ Ð²ÑÐµÐ³Ð´Ð° Ð±Ñ€Ð°Ð» Ð´ÐµÑ„Ð¾Ð»Ñ‚, Ñ€ÐµÑˆÐ¸Ð» Ð¿Ð¾Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐºÐ·Ð¾Ñ‚Ð¸ÐºÑƒ, Ñ Ð²Ð·ÑÐ», Ð¿Ð¾Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ð» Ð¸ Ð¿Ñ…ÑƒÐµÐ», Ñ Ñ‚Ð°ÐºÐ¾Ð³Ð¾ Ð³Ð¾Ð²Ð½Ð° Ð½Ðµ Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ð» Ð½Ð¸ÐºÐ¾Ð³Ð´Ð°, ÑÑ‚Ð¾ Ð²Ð¸Ð´Ð¸Ð¼Ð¾ Ð¾Ñ‚ ÐºÐ°ÐºÐ¾Ð³Ð¾-Ñ‚Ð¾ Ð¼ÐµÑÑ‚Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»Ñ".to_string(),
        "Ð­Ñ‚Ð¾ 90 Ð°Ð¹ÐºÑŒÑŽ ÑŽÐ¼Ð¾Ñ€ Ñ Ð”Ð°ÑƒÐ½".to_string(),
        "Ð”Ð°, Ð´Ð°Ð²Ð°Ð¹ Ñ Ñ‚Ð¾Ð±Ð¾Ð¹ Ð¿Ð¾Ð´ÐµÑ€ÐµÐ¼ÑÑ, ÐµÑÐ»Ð¸ Ñ Ð¿Ð¾Ð±ÐµÐ¶Ð´Ð°ÑŽ, Ñ Ñ‚ÐµÐ±Ñ Ð¸Ð· ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€Ñ‹ Ð²Ñ‹Ð¿Ð¸ÑÑ‹Ð²Ð°ÑŽ, Ð° ÐµÑÐ»Ð¸ Ñ‚Ñ‹, Ñ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð·Ð°Ð¿Ð»Ð°Ñ‡Ñƒ Ð¸ Ð´Ð¾Ð¼Ð¾Ð¹ Ð¿Ð¾Ð¹Ð´Ñƒ".to_string(),
    ];
    let mut rng = rand::rng();
    match pool.choose(&mut rng) {
        Some(quote) => quote.clone(),
        None => panic!("Can't find quote"),
    }
}

pub async fn process_stream_msg(bot: Bot, update: Update, _: Me) -> Result<(), Error> {
    match update.kind {
        teloxide::types::UpdateKind::Message(msg) => match msg.text() {
            Some(txt) => {
                if txt.to_lowercase().contains(STREAM_KEYWORD) {
                    let quote = random_quote();
                    let _ = bot.send_message(msg.chat.id, quote).reply_to(msg.id).await;
                    let _ = bot
                        .set_message_reaction(msg.chat.id, msg.id)
                        .reaction(vec![ReactionType::Emoji {
                            emoji: "ðŸ¤¡".to_string(),
                        }])
                        .await;
                }
                Ok(())
            }
            None => Ok(()),
        },
        _ => Ok(()),
    }
}
